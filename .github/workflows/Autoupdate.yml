name: Autoupdate

on:
  schedule:
    - cron: '0 0 * * *' # 每天凌晨 0 点运行
  push:
    branches:
      - "main"
  workflow_dispatch: 

jobs:
  update-dns-lists:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: checkout actions
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Update domain list
        working-directory: ./AutoUpdate
        run: |
          # 1. 清理旧文件
          rm -f accelerated-domains.china.conf CNDomains_AdguardHome.txt \
              gfwlist.txt gfwlist_decode.txt gfwlist2dnsmasq.sh \
              gfwlist_dnsmasq.conf gfwlist_AdguardHome.txt dns_upstream_merged.txt \
              mosdns_china_list.txt

          # 2. 下载最新源
          wget https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf
          wget https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt
          wget https://raw.githubusercontent.com/cokebar/gfwlist2dnsmasq/master/gfwlist2dnsmasq.sh

          # 3. 处理数据
          base64 -d gfwlist.txt > gfwlist_decode.txt
          python domain_list_converter.py china accelerated-domains.china.conf
          chmod +x gfwlist2dnsmasq.sh
          ./gfwlist2dnsmasq.sh -o ./gfwlist_dnsmasq.conf
          python domain_list_converter.py gfw gfwlist_dnsmasq.conf

          # 4. 合并生成 AdGuardHome 格式
          {
            echo "# Create Date: $(date +"%Y-%m-%d %H:%M:%S")"
            cat upstreams.txt
            printf "\n"
            cat gfwlist_AdguardHome.txt
            cat CNDomains_AdguardHome.txt
          } > dns_upstream_merged.txt

          # 5. 【新增】生成 MosDNS 专用纯文本列表 (仅提取中国域名)
          # 原理：从 CNDomains_AdguardHome.txt 中提取 [/domain/] 格式中的域名
          # 并将 / 替换为换行，确保 MosDNS domain_set 可以读取
          grep -oP '(?<=\[/).*(?=/\])' CNDomains_AdguardHome.txt | tr '/' '\n' | sort -u > mosdns_china_list.txt

          # 6. 覆盖到仓库根目录
          cp dns_upstream_merged.txt ../AdguardHome_Upstreams_Autoupdate.txt
          cp dns_upstream_merged.txt ../AdguardHome_Upstreams_Autoupdate.yaml
          cp mosdns_china_list.txt ../mosdns_china_list.txt

          # 7. 二次清理
          rm -f accelerated-domains.china.conf CNDomains_AdguardHome.txt \
              gfwlist.txt gfwlist_decode.txt gfwlist2dnsmasq.sh \
              gfwlist_dnsmasq.conf gfwlist_AdguardHome.txt dns_upstream_merged.txt \
              mosdns_china_list.txt

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update DNS list: $(date +'%Y-%m-%d')"
            git push
          fi
